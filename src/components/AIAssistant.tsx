import { useState, useRef, useEffect } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import Icon from '@/components/ui/icon';

interface Message {
  role: 'user' | 'assistant';
  content: string;
}

const ALLOWED_TOPICS = [
  '–∫–∞–∫ –Ω–∞–π—Ç–∏ –≥—Ä—É–∑',
  '–∫–∞–∫ –Ω–∞–π—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è',
  '—á—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —Ü–≤–µ—Ç–∞',
  '–∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç',
  '–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è',
  '—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
  '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
  '—É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è',
  '—Ç–∞—Ä–∏—Ñ—ã',
  '–æ–ø–ª–∞—Ç–∞',
  '–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ',
  '—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
  '—Ä–µ–π—Ç–∏–Ω–≥',
  '–æ—Ç–∑—ã–≤—ã',
  '–¥–æ–∫—É–º–µ–Ω—Ç—ã',
  '–ø—Ä–æ—Ñ–∏–ª—å',
  '–Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
  '–ø–æ–º–æ—â—å',
  '–ø–æ–¥–¥–µ—Ä–∂–∫–∞',
  '—Å—Ç–∞—Ç—É—Å',
  '–º–∞—Ä—à—Ä—É—Ç',
  '—Ñ–æ—Ç–æ',
  '–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ',
  '–∏—Å—Ç–æ—Ä–∏—è',
  '–ø–∞—Ä–∫',
  '–∞–≤—Ç–æ–º–æ–±–∏–ª—å',
  '–æ—Ç–¥—ã—Ö',
  '–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è'
];

const predefinedAnswers: Record<string, string> = {
  '–∫–∞–∫ –Ω–∞–π—Ç–∏ –≥—Ä—É–∑': '–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –≥—Ä—É–∑: 1) –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å "–°–≤–æ–±–æ–¥–µ–Ω" 2) –£–∫–∞–∂–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –≤ –ø–æ–ª–µ "–ü–æ–∏—Å–∫ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É" 3) –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã –≥—Ä—É–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≥–æ—Ç–æ–≤—ã –≤–µ–∑—Ç–∏ 4) –ù–∞ –∫–∞—Ä—Ç–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≥—Ä—É–∑—ã',
  '–∫–∞–∫ –Ω–∞–π—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è': '–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è: 1) –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞ (–≥–æ—Ç–æ–≤/–±—É–¥–µ—Ç –≥–æ—Ç–æ–≤) 2) –í–≤–µ–¥–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ 3) –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ 4) –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–∑–∞ 5) –ù–∞ –∫–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–æ–¥–∏—Ç–µ–ª–∏',
  '—á—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —Ü–≤–µ—Ç–∞': '–¶–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–æ–≤: üü¢ –ó–µ–ª—ë–Ω—ã–π ‚Äî —Å–≤–æ–±–æ–¥–µ–Ω/–≥–æ—Ç–æ–≤ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ, üü° –ñ—ë–ª—Ç—ã–π ‚Äî –µ—Å—Ç—å –º–µ—Å—Ç–∞/–±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫–æ –≤—Ä–µ–º–µ–Ω–∏, üî¥ –ö—Ä–∞—Å–Ω—ã–π ‚Äî –Ω–µ—Ç –º–µ—Å—Ç/–∑–∞–Ω—è—Ç',
  '–∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç': '–í–≤–µ–¥–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –≤ –ø–æ–ª—è—Ö "–û—Ç–∫—É–¥–∞" –∏ "–ö—É–¥–∞", –∑–∞—Ç–µ–º —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" —Å–æ –∑–≤—ë–∑–¥–æ—á–∫–æ–π. –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ.',
  '–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è': '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ú–æ—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è" ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∂–µ—Ç –±–ª–∏–∂–∞–π—à–∏–µ –≥—Ä—É–∑—ã –∏–ª–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π.',
  '—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è': '–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Ä–∞–∑–º–µ—â–∞—Ç—å –∑–∞–∫–∞–∑—ã –∏ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.',
  '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ì—Ä—É–∑ –ö–ª–∏–∫. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—É–Ω–∫—Ç—ã: 1) –ß–µ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –æ –≥—Ä—É–∑–∞—Ö –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ 2) –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—Ä–æ–∫–æ–≤ 3) –ó–∞–ø—Ä–µ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞ 4) –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö 5) –ü—Ä–∞–≤–∏–ª–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤',
  '—É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è': '–û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞, –∫–æ–º–∏—Å—Å–∏—è –±–µ—Ä—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–¥–µ–ª–∫–µ (5% –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π, 3% –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤). –ó–∞–ø—Ä–µ—â–µ–Ω–æ: —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ñ–µ–π–∫–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π, —Å–ø–∞–º, –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ.',
  '—Ç–∞—Ä–∏—Ñ—ã': '–¢–∞—Ä–∏—Ñ—ã –ì—Ä—É–∑ –ö–ª–∏–∫: –±–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∫–æ–º–∏—Å—Å–∏—è 5% –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏ 3% –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–¥–µ–ª–∫–µ. –ü—Ä–µ–º–∏—É–º —Ç–∞—Ä–∏—Ñ (—Å–∫–æ—Ä–æ): –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ø–æ–∏—Å–∫–µ, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.',
  '–æ–ø–ª–∞—Ç–∞': '–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏, –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥. –î–µ–Ω—å–≥–∏ —É–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.',
  '–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ': '–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ò—Å—Ç–æ—Ä–∏—è". –í—ã –≤–∏–¥–∏—Ç–µ: —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è, —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏, —Ä–∞—Å—á—ë—Ç–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è. –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ.',
  '—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—Ä–∏: –Ω–æ–≤–æ–º –ø–æ–¥—Ö–æ–¥—è—â–µ–º –∑–∞–∫–∞–∑–µ/–≤–æ–¥–∏—Ç–µ–ª–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏, –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è –∫ —Ç–æ—á–∫–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü—Ä–æ—Ñ–∏–ª—å".',
  '—Ä–µ–π—Ç–∏–Ω–≥': '–†–µ–π—Ç–∏–Ω–≥ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –æ—Ü–µ–Ω–æ–∫ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏. –í–ª–∏—è—é—Ç: –∫–∞—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥, —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—Ä–æ–∫–æ–≤, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä—É–∑–∞. –í—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ø–æ–∏—Å–∫–µ.',
  '–æ—Ç–∑—ã–≤—ã': '–û—Ç–∑—ã–≤—ã –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ò—Å—Ç–æ—Ä–∏—è". –û–Ω–∏ –≤–∏–¥–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥. –ó–∞–ø—Ä–µ—â–µ–Ω—ã: –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, –ª–æ–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.',
  '–¥–æ–∫—É–º–µ–Ω—Ç—ã': '–í —Ä–∞–∑–¥–µ–ª–µ "–î–æ–∫—É–º–µ–Ω—Ç—ã" –º–æ–∂–Ω–æ: —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é, —Å—á—ë—Ç-—Ñ–∞–∫—Ç—É—Ä—É, –∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç. –î–æ–∫—É–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞.',
  '–ø—Ä–æ—Ñ–∏–ª—å': '–í –ø—Ä–æ—Ñ–∏–ª–µ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ: –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –î–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π: –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã.',
  '–Ω–∞—Å—Ç—Ä–æ–π–∫–∏': '–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: —è–∑—ã–∫ (RU/EN/KZ), –≤–∞–ª—é—Ç–∞ (‚ÇΩ/$/‚Ç∏), —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (push/email/sms), —Ç–µ–º–∞ (—Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è), –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è (–∫–º/–º–∏–ª–∏).',
  '–ø–æ–º–æ—â—å': '–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã: 1) –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–æ—Ç —á–∞—Ç ‚Äî –∑–¥–µ—Å—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã 2) –ù–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å 3) –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –≥–æ—Ä—è—á–µ–π –ª–∏–Ω–∏–∏: +7 (XXX) XXX-XX-XX',
  '—Å—Ç–∞—Ç—É—Å': '–°—Ç–∞—Ç—É—Å—ã –≤–æ–¥–∏—Ç–µ–ª—è: üü¢ –°–≤–æ–±–æ–¥–µ–Ω (–≥–æ—Ç–æ–≤ –≤–∑—è—Ç—å –∑–∞–∫–∞–∑), üü° –ï—Å—Ç—å –º–µ—Å—Ç–∞ (–º–æ–∂–µ—Ç –≤–∑—è—Ç—å –ø–æ–ø—É—Ç–Ω—ã–π –≥—Ä—É–∑), üî¥ –ù–µ—Ç –º–µ—Å—Ç (–∑–∞–Ω—è—Ç). –°—Ç–∞—Ç—É—Å—ã –≥—Ä—É–∑–∞: –ì–æ—Ç–æ–≤ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ, –ë—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫–æ –≤—Ä–µ–º–µ–Ω–∏.',
  '–º–∞—Ä—à—Ä—É—Ç': '–ú–∞—Ä—à—Ä—É—Ç—ã –º–æ–∂–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞, —Å—Ç—Ä–æ–∏—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ç–æ—á–∫–∞–º–∏, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏/—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–¥–µ–ª "–ú–∞—Ä—à—Ä—É—Ç—ã" –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.',
  '—Ñ–æ—Ç–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ': '–§–æ—Ç–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ: —Ñ–æ—Ç–æ –≥—Ä—É–∑–∞ –ø—Ä–∏ –ø–æ–≥—Ä—É–∑–∫–µ, —Ñ–æ—Ç–æ –ø—Ä–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–µ, –ø–æ–¥–ø–∏—Å—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç —Å–ø–æ—Ä–æ–≤.',
  '–∏—Å—Ç–æ—Ä–∏—è': '–í —Ä–∞–∑–¥–µ–ª–µ "–ò—Å—Ç–æ—Ä–∏—è" –¥–æ—Å—Ç—É–ø–Ω—ã: –≤—Å–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã, —Ç–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏, –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏. –ú–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º.',
  '–∞–≤—Ç–æ–ø–∞—Ä–∫': '–í —Ä–∞–∑–¥–µ–ª–µ "–ê–≤—Ç–æ–ø–∞—Ä–∫" —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º: –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –æ—Ç–º–µ—á–∞–π—Ç–µ –≤–æ–¥–∏—Ç–µ–ª–µ–π, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ç–µ—Ö–æ—Å–º–æ—Ç—Ä—ã.',
  '–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞': '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏, –ø—Ä–æ–±–∫–∏, —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–ø–ª–∏–≤–∞. –î–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–∞—Ä—à—Ä—É—Ç—ã" ‚Äî –∫–Ω–æ–ø–∫–∞ "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å".'
};

const sanitizeInput = (input: string): string => {
  return input
    .toLowerCase()
    .replace(/<script[^>]*>.*?<\/script>/gi, '')
    .replace(/<[^>]+>/g, '')
    .replace(/javascript:/gi, '')
    .replace(/on\w+\s*=/gi, '')
    .trim()
    .slice(0, 200);
};

const isAllowedQuestion = (question: string): boolean => {
  const sanitized = sanitizeInput(question);
  return ALLOWED_TOPICS.some(topic => sanitized.includes(topic));
};

const AIAssistant = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<Message[]>([
    {
      role: 'assistant',
      content: '–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –ì—Ä—É–∑ –ö–ª–∏–∫ üëã –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Ä–∞–±–æ—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–∏. –ú–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å –≥–æ–ª–æ—Å–æ–º!'
    }
  ]);
  const [input, setInput] = useState('');
  const [isListening, setIsListening] = useState(false);
  const recognitionRef = useRef<any>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = false;
      recognitionRef.current.interimResults = false;
      recognitionRef.current.lang = 'ru-RU';

      recognitionRef.current.onresult = (event: any) => {
        const transcript = event.results[0][0].transcript;
        setInput(transcript);
        setIsListening(false);
      };

      recognitionRef.current.onerror = () => {
        setIsListening(false);
      };

      recognitionRef.current.onend = () => {
        setIsListening(false);
      };
    }
  }, []);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const quickQuestions = [
    '–ö–∞–∫ –Ω–∞–π—Ç–∏ –≥—Ä—É–∑?',
    '–ö–∞–∫ –Ω–∞–π—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è?',
    '–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —Ü–≤–µ—Ç–∞?',
    '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ'
  ];

  const handleVoiceInput = () => {
    if (!recognitionRef.current) {
      alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
      return;
    }

    if (isListening) {
      recognitionRef.current.stop();
    } else {
      recognitionRef.current.start();
      setIsListening(true);
    }
  };

  const handleSend = (question?: string) => {
    const userMessage = question || input;
    if (!userMessage.trim()) return;

    const sanitized = sanitizeInput(userMessage);
    
    if (!isAllowedQuestion(sanitized)) {
      const warningMessages: Message[] = [
        ...messages,
        { role: 'user', content: userMessage },
        { 
          role: 'assistant', 
          content: '‚ö†Ô∏è –ò–∑–≤–∏–Ω–∏—Ç–µ, —è –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ì—Ä—É–∑ –ö–ª–∏–∫ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±—ã—Å—Ç—Ä—ã–π –≤–æ–ø—Ä–æ—Å –≤—ã—à–µ.' 
        }
      ];
      setMessages(warningMessages);
      setInput('');
      return;
    }

    const newMessages: Message[] = [
      ...messages,
      { role: 'user', content: userMessage }
    ];

    let answer = '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –±—ã—Å—Ç—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ü–æ–º–Ω–∏—Ç–µ: —è –æ—Ç–≤–µ—á–∞—é —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –ì—Ä—É–∑ –ö–ª–∏–∫ –∏ —É—Å–ª–æ–≤–∏—è—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.';

    for (const [key, value] of Object.entries(predefinedAnswers)) {
      if (sanitized.includes(key)) {
        answer = value;
        break;
      }
    }

    newMessages.push({ role: 'assistant', content: answer });
    setMessages(newMessages);
    setInput('');
  };

  if (!isOpen) {
    return (
      <Button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-4 right-4 z-50 h-14 w-14 rounded-full shadow-2xl hover:scale-110 transition-transform"
        size="icon"
      >
        <Icon name="MessageCircle" size={24} />
      </Button>
    );
  }

  return (
    <Card className="fixed bottom-4 right-4 z-50 w-96 max-w-[calc(100vw-2rem)] shadow-2xl animate-scale-in">
      <CardContent className="p-0">
        <div className="bg-primary text-primary-foreground p-4 rounded-t-xl flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
              <Icon name="Bot" size={18} />
            </div>
            <div>
              <h3 className="font-semibold text-sm">AI –ü–æ–º–æ—â–Ω–∏–∫</h3>
              <p className="text-xs opacity-90">–¢–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</p>
            </div>
          </div>
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setIsOpen(false)}
            className="h-8 w-8 p-0 hover:bg-white/20"
          >
            <Icon name="X" size={18} />
          </Button>
        </div>

        <div className="h-96 overflow-y-auto p-4 space-y-3 bg-gray-50 dark:bg-gray-900">
          {messages.map((msg, idx) => (
            <div
              key={idx}
              className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-[80%] rounded-xl p-3 text-sm ${
                  msg.role === 'user'
                    ? 'bg-primary text-primary-foreground'
                    : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700'
                }`}
              >
                {msg.content}
              </div>
            </div>
          ))}
          <div ref={messagesEndRef} />

          {messages.length === 1 && (
            <div className="space-y-2">
              <p className="text-xs text-center text-muted-foreground mb-2">–ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</p>
              {quickQuestions.map((q, idx) => (
                <Button
                  key={idx}
                  variant="outline"
                  size="sm"
                  onClick={() => handleSend(q)}
                  className="w-full justify-start text-xs h-auto py-2"
                >
                  {q}
                </Button>
              ))}
            </div>
          )}
        </div>

        <div className="p-3 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-950">
          <div className="flex gap-2">
            <Input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSend()}
              placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."
              className="text-sm"
              maxLength={200}
            />
            <Button 
              onClick={handleVoiceInput} 
              size="sm" 
              variant={isListening ? "destructive" : "outline"}
              className="shrink-0"
            >
              <Icon name={isListening ? "MicOff" : "Mic"} size={16} />
            </Button>
            <Button onClick={() => handleSend()} size="sm" className="shrink-0">
              <Icon name="Send" size={16} />
            </Button>
          </div>
          <p className="text-[10px] text-muted-foreground mt-1 text-center">
            üîí –ó–∞—â–∏—â—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
          </p>
        </div>
      </CardContent>
    </Card>
  );
};

export default AIAssistant;
